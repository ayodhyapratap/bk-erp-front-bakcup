(this["webpackJsonpbk-erp-front"]=this["webpackJsonpbk-erp-front"]||[]).push([[22],{1073:function(e,t){},1252:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return j}));n(226);var a=n(227),o=(n(229),n(228)),i=(n(236),n(237)),r=(n(231),n(232)),c=n(47),s=n(31),l=n(95),d=n(94),u=n(97),m=n(96),f=n(24),p=n(98),g=n(0),v=n.n(g),E=n(1045),h=n.n(E),b=n(34),_=n(23),y=n(2),C=null,S=null,A={},D={},j=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(u.a)(this,Object(m.a)(t).call(this,e))).setFocusedPeer=function(e){var t=n.state,a=t.DEFAULT_CHANNEL,o=t.MUTE_CHANNEL;if(!n.state.is_admin)return Object(_.a)(y.bc,"You are not allowed for this action."),!1;n.setState({focusedPeer:e}),C.send({admin:e,peer_id:"admin",channel:a,mute:o})},n.loadMeeting=function(e){var t=Object(f.a)(n);Object(_.c)(Object(_.f)(b.od,[e]),(function(e){var n=!1;e.admins.forEach((function(e){t.props.user.staff&&t.props.user.staff.id==e&&(n=!0)})),t.setState({meetingDetails:e,is_admin:n}),t.changeChannel(e.meeting_id)}),(function(){}))},n.changeChannel=function(e){e=e||"default";var t=Object(f.a)(n);n.setState({DEFAULT_CHANNEL:e},(function(){t.init()}))},n.init=function(){var e=Object(f.a)(n);console.log("Connecting to signaling server");var t=n.state,a=t.SIGNALING_SERVER,o=t.DEFAULT_CHANNEL,i=t.ICE_SERVERS,r=t.MUTE_CHANNEL;(C=h()(a)).on("message",(function(t){console.log("userDetails",t),console.log("admin",t.admin),e.setState({meetingUserDetails:t,MUTE_CHANNEL:t.mute})})),C.on("connect",(function(){console.log("Connected to signaling server"),e.setupLocalMedia((function(){var e,t;e=o,t={"whatever-you-want-here":"stuff"},C.emit("join",{channel:e,userdata:t})}))})),C.on("disconnect",(function(){console.log("Disconnected from signaling server"),A={},D={}})),C.on("addPeer",(function(t){console.log("Signaling server said to add peer:",t);var n=t.peer_id;if(n in A)console.log("Already connected to peer ",n);else{var a=new RTCPeerConnection({iceServers:i},{optional:[{DtlsSrtpKeyAgreement:!0}]});console.log("New Peer Connection",a),A[n]=a,a.onicecandidate=function(e){e.candidate&&C.emit("relayICECandidate",{peer_id:n,ice_candidate:{sdpMLineIndex:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate}})},a.onaddstream=function(t){console.log("onAddStream",t);var a=v.a.createElement("video",{key:n,ref:function(e){e&&(e.srcObject=t.stream)},autoPlay:!0,style:{width:"100%"}});D[n]=a,e.setState((function(e){return{availablePeers:Object(s.a)({},e.availablePeers,Object(c.a)({},n,!0))}}))},a.addStream(S),t.should_create_offer&&(console.log("Creating RTC offer to ",n),a.createOffer((function(e){console.log("Local offer description is: ",e),a.setLocalDescription(e,(function(){C.emit("relaySessionDescription",{peer_id:n,session_description:e}),console.log("Offer setLocalDescription succeeded")}),(function(){Object(_.a)(y.Q,"Offer setLocalDescription failed!")}))}),(function(e){console.log("Error sending offer: ",e)})))}})),C.on("sessionDescription",(function(t){console.log("Remote description received: ",t);var n=t.peer_id,a=A[n],i=t.session_description;console.log(t.session_description);var c=Object(s.a)({},e.props.user,{peer_id:n,channel:o,mute:r});(e.state.is_admin||c.is_superuser)&&(c.admin=!0,C.send({admin:n,peer_id:"admin",channel:o,mute:r})),e.setState({myPeerId:t.peer_id}),C.send(c);var l=new RTCSessionDescription(i);a.setRemoteDescription(l,(function(){console.log("setRemoteDescription succeeded"),"offer"==i.type&&(console.log("Creating answer"),a.createAnswer((function(e){console.log("Answer description is: ",e),a.setLocalDescription(e,(function(){C.emit("relaySessionDescription",{peer_id:n,session_description:e}),console.log("Answer setLocalDescription succeeded")}),(function(){Object(_.a)(y.Q,"Answer setLocalDescription failed!")}))}),(function(e){console.log("Error creating answer: ",e),console.log(a)})))}),(function(e){console.log("setRemoteDescription error: ",e)}));console.log("Description Object: ",l)})),C.on("iceCandidate",(function(e){var t=A[e.peer_id],n=e.ice_candidate;t.addIceCandidate(new RTCIceCandidate(n))})),C.on("removePeer",(function(t){console.log("Signaling server said to remove peer:",t);var n=t.peer_id;D[n]=v.a.createElement("video",{src:""}),A[n].close(),delete A[n],delete D[t.peer_id],e.setState((function(e){var t=Object(s.a)({},e.availablePeers);return delete t[n],{availablePeers:Object(s.a)({},t)}}),(function(){}))}))},n.setupLocalMedia=function(e,t){var a=Object(f.a)(n);null==S?(console.log("Requesting access to local audio / video inputs"),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({audio:!0,video:!0},(function(t){console.log("Access granted to audio/video"),S=t;var n=v.a.createElement("video",{key:"me",muted:!0,autoPlay:!0,style:{width:"100%"},ref:function(e){e&&(e.srcObject=t)}});a.setState({localMediaComponent:n}),e&&e()}),(function(){console.log("Access denied for audio/video"),alert("You chose not to provide access to the camera/microphone, demo will not work."),t&&t()}))):e&&e()},n.state={myPeerId:null,is_admin:!1,meetingDetails:{},SIGNALING_SERVER:"https://bk-erp.plutonic.co.in",DEFAULT_CHANNEL:"",ICE_SERVERS:[{url:"stun:bk-erp.plutonic.co.in:3478",username:"test01",credential:"testdriver"}],localMediaComponent:v.a.createElement("div",null),availablePeers:{},meetingUserDetails:{},MUTE_CHANNEL:!1},n}return Object(p.a)(t,e),Object(d.a)(t,[{key:"componentDidMount",value:function(){this.props.match.params&&this.props.match.params.meetingId&&this.loadMeeting(this.props.match.params.meetingId)}},{key:"render",value:function(){var e=this,t=this.state,n=t.localMediaComponent,c=t.availablePeers,s=t.meetingUserDetails,l=t.meetingDetails,d=t.myPeerId,u=Object.keys(c);return v.a.createElement("div",{style:{minHeight:"100vh",textAlign:"center"}},v.a.createElement("h3",null,l.name),v.a.createElement(a.a,{type:"flex",justify:"center",gutter:16,style:{marginTop:10}},s.me&&s.me.socket===s.admin?v.a.createElement(i.a,{xs:24,sm:12,md:12,lg:12,xl:12,key:d},v.a.createElement(r.a,{bodyStyle:{padding:0,textAlign:"center"}},n,v.a.createElement("h4",null,s[s.admin]?s[s.admin].first_name:"--"," "))):u.map((function(t){return s.admin===t?v.a.createElement(i.a,{xs:24,sm:12,md:12,lg:12,xl:12,key:t},v.a.createElement(r.a,{bodyStyle:{padding:0,textAlign:"center"}},D[t],v.a.createElement("h4",null,s[t]?s[t].first_name:"--",v.a.createElement(o.a,{type:"danger",shape:"circle",icon:"close",onClick:function(){return e.setFocusedPeer(s.me?s.me.socket:null)},style:{float:"right"}})))):null}))),v.a.createElement(a.a,{gutter:16,style:{marginTop:10},type:"flex",justify:"center"},v.a.createElement(i.a,{xs:24,sm:12,md:4,lg:4,xl:3},v.a.createElement(r.a,{key:"me",bodyStyle:{padding:0,textAlign:"center"}},n,v.a.createElement("h4",null,"ME"))),u.map((function(t){return v.a.createElement(i.a,{xs:8,sm:8,md:4,lg:4,xl:3,key:t,onClick:function(){return e.setFocusedPeer(t)}},v.a.createElement(r.a,{bodyStyle:{padding:0,textAlign:"center"}},D[t],v.a.createElement("h4",null,s[t]?s[t].first_name:"--")))}))))}}]),t}(v.a.Component)}}]);
//# sourceMappingURL=22.8cda571f.chunk.js.map